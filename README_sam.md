# SAM2 å¢å¼ºç‰ˆæ‰¹é‡å›¾åƒMaskç”Ÿæˆå™¨

åŸºäºMetaçš„SAM2 (Segment Anything Model 2) çš„å¢å¼ºç‰ˆæ‰¹é‡å›¾åƒåˆ†å‰²å·¥å…·ï¼Œå…·æœ‰æ›´å¥½çš„é”™è¯¯å¤„ç†ã€é…ç½®ç®¡ç†å’Œæ€§èƒ½ä¼˜åŒ–ã€‚

## ğŸš€ å¿«é€Ÿå¼€å§‹


### æ‰‹åŠ¨å®‰è£…å’Œè¿è¡Œ
```bash
# 1. å®‰è£…ä¾èµ–
pip install torch torchvision numpy matplotlib pillow opencv-python tqdm psutil pyyaml

# 2. ä¸‹è½½æ¨¡å‹æ–‡ä»¶
cd checkpoints
bash download_ckpts.sh

# 3. è¿è¡Œæ‰¹é‡å¤„ç†
python mask_generator.py ./images
```

## ğŸ“ æ–‡ä»¶è¯´æ˜

- `mask_generator.py` - å¢å¼ºç‰ˆä¸»ç¨‹åº

## âœ¨ ä¸»è¦åŠŸèƒ½

### ğŸ”§ å¢å¼ºåŠŸèƒ½
- **è‡ªåŠ¨é…ç½®æ£€æµ‹**: è‡ªåŠ¨æŸ¥æ‰¾å¯ç”¨çš„æ¨¡å‹å’Œé…ç½®æ–‡ä»¶
- **é…ç½®æ–‡ä»¶æ”¯æŒ**: æ”¯æŒYAML/JSONé…ç½®æ–‡ä»¶ç®¡ç†å‚æ•°
- **é”™è¯¯å¤„ç†**: å®Œå–„çš„é”™è¯¯å¤„ç†å’Œç”¨æˆ·å‹å¥½çš„é”™è¯¯ä¿¡æ¯
- **èµ„æºç›‘æ§**: å†…å­˜å’ŒGPUä½¿ç”¨ç›‘æ§
- **å¹¶è¡Œå¤„ç†**: æ”¯æŒå¤šçº¿ç¨‹å¹¶è¡Œå¤„ç†ï¼ˆé€‚ç”¨äºCPUå¯†é›†å‹ä»»åŠ¡ï¼‰
- **è¿›åº¦æ˜¾ç¤º**: å®æ—¶è¿›åº¦æ¡å’Œå¤„ç†çŠ¶æ€
- **æ—¥å¿—ç³»ç»Ÿ**: å¯é…ç½®çš„æ—¥å¿—çº§åˆ«å’Œæ–‡ä»¶è¾“å‡º
- **å‚æ•°éªŒè¯**: è‡ªåŠ¨éªŒè¯è¾“å…¥å‚æ•°å’Œæ–‡ä»¶è·¯å¾„

### ğŸ¯ æ ¸å¿ƒåŠŸèƒ½
- **æ‰¹é‡å¤„ç†**: å¤„ç†æ•´ä¸ªæ–‡ä»¶å¤¹ä¸­çš„æ‰€æœ‰å›¾ç‰‡
- **éšæœºé‡‡æ ·**: æ”¯æŒéšæœºé€‰æ‹©Nå¼ å›¾ç‰‡è¿›è¡Œå¤„ç†
- **å¤šæ ¼å¼æ”¯æŒ**: æ”¯æŒJPGã€PNGã€BMPã€TIFFç­‰æ ¼å¼
- **å¤šç§è¾“å‡º**: PNGã€JPGæˆ–ä¸¤ç§æ ¼å¼åŒæ—¶è¾“å‡º
- **è®¾å¤‡è‡ªé€‚åº”**: è‡ªåŠ¨æ£€æµ‹å¹¶ä½¿ç”¨CUDAã€MPSæˆ–CPU
- **å¯è§†åŒ–ç»“æœ**: ç”Ÿæˆå¸¦æœ‰maskå åŠ çš„å¯è§†åŒ–å›¾åƒ
- **åŸå§‹æ•°æ®ä¿å­˜**: å¯é€‰ä¿å­˜åŸå§‹maskæ•°æ®ï¼ˆ.npyæ ¼å¼ï¼‰

## ğŸ“– ä½¿ç”¨æ–¹æ³•

### åŸºæœ¬ç”¨æ³•
```bash
# å¤„ç†æ‰€æœ‰å›¾ç‰‡
python mask_generator.py ./images

# éšæœºå¤„ç†10å¼ å›¾ç‰‡
python mask_generator.py ./images --limit 10

# æŒ‡å®šè¾“å‡ºç›®å½•
python mask_generator.py ./images --output ./results

# è‡ªåŠ¨æ£€æµ‹æ¨¡å‹æ–‡ä»¶
python mask_generator.py ./images --auto-detect
```

### ä½¿ç”¨é…ç½®æ–‡ä»¶
```bash
# ä½¿ç”¨é…ç½®æ–‡ä»¶
python mask_generator.py ./images --config-file config_example.yaml

# é…ç½®æ–‡ä»¶ + å‘½ä»¤è¡Œå‚æ•°ï¼ˆå‘½ä»¤è¡Œå‚æ•°ä¼˜å…ˆï¼‰
python mask_generator.py ./images --config-file config.yaml --limit 5
```

### é«˜çº§ç”¨æ³•
```bash
# é«˜è´¨é‡æ¨¡å¼
python mask_generator.py ./images \
  --points-per-side 64 \
  --pred-iou-thresh 0.92 \
  --stability-score-thresh 0.97

# å¿«é€Ÿæ¨¡å¼
python mask_generator.py ./images \
  --points-per-side 16 \
  --pred-iou-thresh 0.85 \
  --max-workers 4

# ä¿å­˜è¯¦ç»†æ—¥å¿—
python mask_generator.py ./images \
  --log-level DEBUG \
  --log-file processing.log
```

## âš™ï¸ å‚æ•°è¯´æ˜

### åŸºæœ¬å‚æ•°
| å‚æ•° | è¯´æ˜ | é»˜è®¤å€¼ |
|------|------|--------|
| `input_dir` | è¾“å…¥å›¾ç‰‡ç›®å½• | å¿…éœ€ |
| `--output, -o` | è¾“å‡ºç›®å½• | `output` |
| `--limit, -l` | å¤„ç†å›¾ç‰‡æ•°é‡é™åˆ¶ | æ— é™åˆ¶ |
| `--seed` | éšæœºç§å­ | `42` |

### æ¨¡å‹å‚æ•°
| å‚æ•° | è¯´æ˜ | é»˜è®¤å€¼ |
|------|------|--------|
| `--checkpoint, -c` | æ¨¡å‹æ–‡ä»¶è·¯å¾„ | è‡ªåŠ¨æ£€æµ‹ |
| `--config` | é…ç½®æ–‡ä»¶è·¯å¾„ | è‡ªåŠ¨æ£€æµ‹ |
| `--auto-detect` | è‡ªåŠ¨æ£€æµ‹æ¨¡å‹æ–‡ä»¶ | `False` |

### è¾“å‡ºå‚æ•°
| å‚æ•° | è¯´æ˜ | é»˜è®¤å€¼ |
|------|------|--------|
| `--output-format` | è¾“å‡ºæ ¼å¼ (png/jpg/both) | `png` |
| `--quality` | JPEGè´¨é‡ (1-100) | `95` |
| `--save-masks` | ä¿å­˜åŸå§‹maskæ•°æ® | `False` |

### æ€§èƒ½å‚æ•°
| å‚æ•° | è¯´æ˜ | é»˜è®¤å€¼ |
|------|------|--------|
| `--max-workers` | å¹¶è¡Œçº¿ç¨‹æ•° | `1` |

### SAM2æ¨¡å‹å‚æ•°
| å‚æ•° | è¯´æ˜ | é»˜è®¤å€¼ |
|------|------|--------|
| `--points-per-side` | æ¯è¾¹é‡‡æ ·ç‚¹æ•° | `32` |
| `--pred-iou-thresh` | é¢„æµ‹IoUé˜ˆå€¼ | `0.88` |
| `--stability-score-thresh` | ç¨³å®šæ€§åˆ†æ•°é˜ˆå€¼ | `0.95` |

### æ—¥å¿—å‚æ•°
| å‚æ•° | è¯´æ˜ | é»˜è®¤å€¼ |
|------|------|--------|
| `--log-level` | æ—¥å¿—çº§åˆ« | `INFO` |
| `--log-file` | æ—¥å¿—æ–‡ä»¶è·¯å¾„ | æ—  |

## ğŸ“‹ é…ç½®æ–‡ä»¶ç¤ºä¾‹

```yaml
# config_example.yaml
input_dir: "./images"
output_dir: "./output"
limit: 10
seed: 42

# æ¨¡å‹è®¾ç½®
checkpoint: "checkpoints/sam2.1_hiera_large.pt"
config: "sam2/configs/sam2.1/sam2.1_hiera_l.yaml"

# è¾“å‡ºè®¾ç½®
output_format: "png"
quality: 95
save_masks: false

# æ€§èƒ½è®¾ç½®
max_workers: 1

# SAM2å‚æ•°
points_per_side: 32
pred_iou_thresh: 0.88
stability_score_thresh: 0.95

# æ—¥å¿—è®¾ç½®
log_level: "INFO"
log_file: null
```

## ğŸ›ï¸ ä¸åŒåœºæ™¯çš„æ¨èé…ç½®

### é«˜è´¨é‡æ¨¡å¼ï¼ˆé€Ÿåº¦æ…¢ï¼Œè´¨é‡é«˜ï¼‰
```yaml
points_per_side: 64
pred_iou_thresh: 0.92
stability_score_thresh: 0.97
max_workers: 1
```

### å¿«é€Ÿæ¨¡å¼ï¼ˆé€Ÿåº¦å¿«ï¼Œè´¨é‡ä¸­ç­‰ï¼‰
```yaml
points_per_side: 16
pred_iou_thresh: 0.85
stability_score_thresh: 0.90
max_workers: 4  # ä»…CPUæ—¶æœ‰æ•ˆ
```

### å¹³è¡¡æ¨¡å¼ï¼ˆé»˜è®¤è®¾ç½®ï¼‰
```yaml
points_per_side: 32
pred_iou_thresh: 0.88
stability_score_thresh: 0.95
max_workers: 1
```

## ğŸ”§ ç¯å¢ƒè¦æ±‚

### Pythonç‰ˆæœ¬
- Python 3.8+

### å¿…éœ€ä¾èµ–
```bash
pip install torch torchvision numpy matplotlib pillow opencv-python tqdm psutil pyyaml
```

### å¯é€‰ä¾èµ–
- CUDA (ç”¨äºGPUåŠ é€Ÿ)
- MPS (ç”¨äºApple Silicon Mac GPUåŠ é€Ÿ)

### æ¨¡å‹æ–‡ä»¶
ä¸‹è½½SAM2æ¨¡å‹æ–‡ä»¶åˆ° `checkpoints/` ç›®å½•ï¼š
- `sam2.1_hiera_large.pt` (æ¨è)
- `sam2.1_hiera_base_plus.pt`
- `sam2.1_hiera_small.pt`
- `sam2.1_hiera_tiny.pt`

## ğŸ“Š è¾“å‡ºç»“æœ

å¤„ç†å®Œæˆåï¼Œè¾“å‡ºç›®å½•å°†åŒ…å«ï¼š

```
output/
â”œâ”€â”€ image1_masks.png          # å¯è§†åŒ–ç»“æœ
â”œâ”€â”€ image2_masks.png
â”œâ”€â”€ image1_masks.npy          # åŸå§‹maskæ•°æ®ï¼ˆå¯é€‰ï¼‰
â””â”€â”€ image2_masks.npy
```

æ¯ä¸ªå¯è§†åŒ–å›¾åƒåŒ…å«ï¼š
- åŸå§‹å›¾åƒ
- å½©è‰²maskå åŠ 
- maskè¾¹ç•Œè½®å»“

## ğŸš€ æ€§èƒ½ä¼˜åŒ–å»ºè®®

### GPUä½¿ç”¨
- ä½¿ç”¨CUDAæˆ–MPSè®¾å¤‡å¯æ˜¾è‘—æå‡é€Ÿåº¦
- GPUæ¨¡å¼ä¸‹å»ºè®® `max_workers=1`
- ç›‘æ§GPUå†…å­˜ä½¿ç”¨ï¼Œé¿å…OOM

### CPUä½¿ç”¨
- CPUæ¨¡å¼ä¸‹å¯é€‚å½“å¢åŠ  `max_workers`
- å»ºè®®æ ¹æ®CPUæ ¸å¿ƒæ•°è®¾ç½®ï¼ˆé€šå¸¸ä¸ºæ ¸å¿ƒæ•°çš„1-2å€ï¼‰

### å†…å­˜ç®¡ç†
- å¤§å›¾ç‰‡æˆ–å¤§æ‰¹é‡å¤„ç†æ—¶æ³¨æ„å†…å­˜ä½¿ç”¨
- ç¨‹åºä¼šè‡ªåŠ¨è¿›è¡Œå†…å­˜æ¸…ç†
- å¯é€šè¿‡æ—¥å¿—ç›‘æ§å†…å­˜ä½¿ç”¨æƒ…å†µ

### å‚æ•°è°ƒä¼˜
- `points_per_side`: å½±å“ç²¾åº¦å’Œé€Ÿåº¦ï¼Œ16-64ä¹‹é—´é€‰æ‹©
- `pred_iou_thresh`: å½±å“maskè´¨é‡ï¼Œ0.8-0.95ä¹‹é—´é€‰æ‹©
- `stability_score_thresh`: å½±å“maskç¨³å®šæ€§ï¼Œ0.9-0.98ä¹‹é—´é€‰æ‹©

## ğŸ› æ•…éšœæ’é™¤

### å¸¸è§é—®é¢˜

1. **æ‰¾ä¸åˆ°æ¨¡å‹æ–‡ä»¶**
   ```
   é”™è¯¯: æ¨¡å‹checkpointä¸å­˜åœ¨
   è§£å†³: è¿è¡Œ --auto-detect æˆ–æ‰‹åŠ¨ä¸‹è½½æ¨¡å‹æ–‡ä»¶
   ```

2. **CUDAå†…å­˜ä¸è¶³**
   ```
   é”™è¯¯: CUDA out of memory
   è§£å†³: å‡å°‘batch sizeæˆ–ä½¿ç”¨CPUæ¨¡å¼
   ```

3. **é…ç½®æ–‡ä»¶æ ¼å¼é”™è¯¯**
   ```
   é”™è¯¯: ä¸æ”¯æŒçš„é…ç½®æ–‡ä»¶æ ¼å¼
   è§£å†³: ä½¿ç”¨YAMLæˆ–JSONæ ¼å¼
   ```

4. **å›¾ç‰‡æ ¼å¼ä¸æ”¯æŒ**
   ```
   é”™è¯¯: æ— æ³•æ‰“å¼€å›¾ç‰‡æ–‡ä»¶
   è§£å†³: ç¡®ä¿å›¾ç‰‡æ ¼å¼ä¸ºJPGã€PNGã€BMPæˆ–TIFF
   ```

### è°ƒè¯•æ¨¡å¼
```bash
# å¯ç”¨è¯¦ç»†æ—¥å¿—
python mask_generator.py ./images --log-level DEBUG

# ä¿å­˜æ—¥å¿—åˆ°æ–‡ä»¶
python mask_generator.py ./images --log-file debug.log
```

## ğŸ§ª æµ‹è¯•

```bash
# è¿è¡Œæµ‹è¯•è„šæœ¬
python test_batch.py

# å¿«é€Ÿæµ‹è¯•
python setup_and_run.py
```

## ğŸ“ æ›´æ–°æ—¥å¿—

### v2.0 (å¢å¼ºç‰ˆ)
- âœ… æ·»åŠ é…ç½®æ–‡ä»¶æ”¯æŒ
- âœ… æ”¹è¿›é”™è¯¯å¤„ç†å’Œç”¨æˆ·ä½“éªŒ
- âœ… æ·»åŠ èµ„æºç›‘æ§å’Œå†…å­˜ç®¡ç†
- âœ… æ”¯æŒå¹¶è¡Œå¤„ç†
- âœ… æ·»åŠ è¿›åº¦æ¡å’Œè¯¦ç»†æ—¥å¿—
- âœ… è‡ªåŠ¨æ¨¡å‹æ£€æµ‹
- âœ… å‚æ•°éªŒè¯å’Œé…ç½®ç®¡ç†
- âœ… å¿«é€Ÿå®‰è£…è„šæœ¬

### v1.0 (åŸºç¡€ç‰ˆ)
- âœ… åŸºæœ¬æ‰¹é‡å¤„ç†åŠŸèƒ½
- âœ… éšæœºé‡‡æ ·æ”¯æŒ
- âœ… å¤šè®¾å¤‡æ”¯æŒ
- âœ… å¯è§†åŒ–è¾“å‡º

## ğŸ“„ è®¸å¯è¯

æœ¬é¡¹ç›®åŸºäºSAM2é¡¹ç›®ï¼Œéµå¾ªç›¸åº”çš„å¼€æºè®¸å¯è¯ã€‚

## ğŸ¤ è´¡çŒ®

æ¬¢è¿æäº¤Issueå’ŒPull Requestæ¥æ”¹è¿›è¿™ä¸ªå·¥å…·ï¼

## ğŸ“ æ”¯æŒ

å¦‚æœé‡åˆ°é—®é¢˜ï¼Œè¯·ï¼š
1. æŸ¥çœ‹æ•…éšœæ’é™¤éƒ¨åˆ†
2. è¿è¡Œè°ƒè¯•æ¨¡å¼è·å–è¯¦ç»†ä¿¡æ¯
3. æäº¤Issueå¹¶é™„ä¸Šé”™è¯¯æ—¥å¿—